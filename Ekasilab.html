<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ekasi Labs — Auth</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b0f14;color:#e5eef7;display:flex;align-items:center;justify-content:center;min-height:100vh}
  .auth-box{background:#121821;padding:20px;border-radius:12px;max-width:480px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,.5)}
  h2{margin-top:0;color:#6ee7ff;text-align:center}
  .row{margin-bottom:10px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:#07101a;color:#e5eef7}
  .btn{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:transparent;color:#e5eef7;cursor:pointer}
  .tabs{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
  .muted{color:#9fb3c8;font-size:13px}
  label{font-size:13px;color:#9fb3c8;display:block;margin-top:6px}
  .small{font-size:13px;padding:8px}
</style>
</head>
<body>
  <div class="auth-box">
    <h2>Ekasi Labs — Login / Register</h2>
    <div class="tabs">
      <button class="btn" onclick="renderPage('login')">Login</button>
      <button class="btn" onclick="renderPage('register')">Register</button>
      <button class="btn" onclick="renderPage('forgot')">Forgot</button>
    </div>
    <div id="auth-content"></div>
    <p class="muted" style="text-align:center;margin-top:12px">Accounts are stored locally in your browser for testing.</p>
  </div>

<script>
/* Keys:
  - ACC_KEY: map username -> { pwHash, salt, questions: [q1hash,q2hash,q3hash], rewards:{coins, diamonds, keys, hints}, profile:{avatarDataUrl,customizations...} }
  - LOGIN_TRACK_KEY: track daily logins per-day
  - LOGGED_IN_KEY: currently logged in username
*/
const ACC_KEY = 'ekasi_accounts_v3';
const LOGIN_TRACK_KEY = 'ekasi_login_stats_v1';
const LOGGED_IN_KEY = 'ekasi_logged_in_user_v3';

function hashString(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h = Math.imul(h ^ s.charCodeAt(i), 16777619); } return (h>>>0).toString(16); }
function getAccounts(){ try{ return JSON.parse(localStorage.getItem(ACC_KEY) || '{}'); }catch(e){ return {}; } }
function saveAccounts(m){ localStorage.setItem(ACC_KEY, JSON.stringify(m)); }

function usernameValid(u){ return u && u.length>=8 && /[A-Z]/.test(u) && /\d/.test(u) && /[^A-Za-z0-9]/.test(u); }
function passwordValid(p){ return p && p.length>=8 && /[A-Z]/.test(p) && /[a-z]/.test(p) && /\d/.test(p) && /[^A-Za-z0-9]/.test(p); }

function toggleShow(id){ const el=document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }

function renderPage(tab){
  const c = document.getElementById('auth-content');
  if(tab === 'login'){
    c.innerHTML = `
      <div class="row"><input id="login-username" placeholder="Username"></div>
      <div class="row"><input id="login-password" type="password" placeholder="Password">
        <label style="margin-top:8px"><input type="checkbox" onclick="toggleShow('login-password')"> Show</label>
      </div>
      <div class="row"><label style="display:flex;gap:8px;align-items:center"><input id="auto-login" type="checkbox"> Auto-login</label></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="doLogin()">Login</button><button class="btn" onclick="renderPage('forgot')">Forgot</button></div>
      <div id="login-msg" class="muted" style="margin-top:8px"></div>`;
  } else if(tab === 'register'){
    c.innerHTML = `
      <div class="row"><input id="reg-username" placeholder="Username (≥8, 1 upper, 1 digit, 1 special)"></div>
      <div class="row"><input id="reg-password" type="password" placeholder="Password (≥8, upper, lower, digit, special)"></div>
      <div class="row"><input id="reg-password2" type="password" placeholder="Confirm password"></div>
      <p class="muted">Answer these 3 security questions (we store hashed answers).</p>
      <div class="row"><label>1) What do you want to achieve with this learning app?</label><input id="a1"></div>
      <div class="row"><label>2) What are your hobbies?</label><input id="a2"></div>
      <div class="row"><label>3) Will you check out my cybersecurity ebook?</label><input id="a3"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="doRegister()">Register</button><button class="btn" onclick="clearRegisterForm()">Clear</button></div>
      <div id="reg-msg" class="muted" style="margin-top:8px"></div>`;
  } else {
    c.innerHTML = `
      <div class="row"><input id="fp-username" placeholder="Username"></div>
      <p class="muted">Answer at least 2 of the same questions you answered during registration.</p>
      <div class="row"><label>1) What do you want to achieve with this learning app?</label><input id="fa1"></div>
      <div class="row"><label>2) What are your hobbies?</label><input id="fa2"></div>
      <div class="row"><label>3) Will you check out my cybersecurity ebook?</label><input id="fa3"></div>
      <div class="row"><input id="fp-newpass" type="password" placeholder="New password"></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="doForgot()">Reset Password</button><button class="btn" onclick="renderPage('login')">Back</button></div>
      <div id="fp-msg" class="muted" style="margin-top:8px"></div>`;
  }
}

function clearRegisterForm(){
  ['reg-username','reg-password','reg-password2','a1','a2','a3','reg-msg'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('reg-msg').textContent='';
}

function doRegister(){
  const u = (document.getElementById('reg-username').value || '').trim();
  const p = document.getElementById('reg-password').value || '';
  const p2 = document.getElementById('reg-password2').value || '';
  const a1 = (document.getElementById('a1').value || '').trim();
  const a2 = (document.getElementById('a2').value || '').trim();
  const a3 = (document.getElementById('a3').value || '').trim();
  const msgEl = document.getElementById('reg-msg');
  msgEl.textContent = '';
  if(!usernameValid(u)){ msgEl.textContent = 'Invalid username — must be ≥8 chars, include uppercase, a digit & special.'; return; }
  if(!passwordValid(p)){ msgEl.textContent = 'Weak password — must meet policy.'; return; }
  if(p !== p2){ msgEl.textContent = 'Passwords do not match.'; return; }
  if(!a1 || !a2 || !a3){ msgEl.textContent = 'Please answer all 3 questions.'; return; }
  const accs = getAccounts();
  if(accs[u]){ msgEl.textContent = 'Username exists — choose another.'; return; }
  const salt = Math.random().toString(36).slice(2,10);
  accs[u] = {
    pwHash: hashString(p + salt),
    salt,
    questions: [ hashString(a1.toLowerCase()+salt), hashString(a2.toLowerCase()+salt), hashString(a3.toLowerCase()+salt) ],
    rewards: { coins:0, diamonds:0, keys:0, hints:0, totalLogins:0 },
    profile: { avatar: null, customization: {} }
  };
  saveAccounts(accs);
  msgEl.textContent = 'Account created — you can now login.';
  setTimeout(()=> renderPage('login'), 800);
}

function doLogin(){
  const u = (document.getElementById('login-username').value || '').trim();
  const p = document.getElementById('login-password').value || '';
  const accs = getAccounts();
  const acc = accs[u];
  const msgEl = document.getElementById('login-msg');
  msgEl.textContent = '';
  if(!acc){ msgEl.textContent = 'No such user.'; return; }
  if(hashString(p + acc.salt) !== acc.pwHash){ msgEl.textContent = 'Wrong password.'; return; }
  // mark logged in
  localStorage.setItem(LOGGED_IN_KEY, u);
  // track login & grant immediate "3 logins -> 2 hints" reward
  trackLoginAndGrant(u);
  // go to labs page
  window.location.href = 'labs.html';
}

function doForgot(){
  const u = (document.getElementById('fp-username').value || '').trim();
  const fa1 = (document.getElementById('fa1').value || '').trim().toLowerCase();
  const fa2 = (document.getElementById('fa2').value || '').trim().toLowerCase();
  const fa3 = (document.getElementById('fa3').value || '').trim().toLowerCase();
  const newpw = (document.getElementById('fp-newpass').value || '');
  const accs = getAccounts();
  const acc = accs[u];
  const msgEl = document.getElementById('fp-msg');
  msgEl.textContent = '';
  if(!acc){ msgEl.textContent = 'No such user.'; return; }
  let correct = 0;
  if(hashString(fa1 + acc.salt) === acc.questions[0]) correct++;
  if(hashString(fa2 + acc.salt) === acc.questions[1]) correct++;
  if(hashString(fa3 + acc.salt) === acc.questions[2]) correct++;
  if(correct < 2){ msgEl.textContent = `Only ${correct} correct — need at least 2.`; return; }
  if(!passwordValid(newpw)){ msgEl.textContent = 'New password fails policy.'; return; }
  // reset password
  const newSalt = Math.random().toString(36).slice(2,10);
  acc.salt = newSalt;
  acc.pwHash = hashString(newpw + newSalt);
  saveAccounts(accs);
  msgEl.textContent = 'Password reset — now login with the new password.';
  setTimeout(()=> renderPage('login'), 900);
}

/* TRACK LOGINS + immediate rewards
   Structure:
     loginStats = { 'YYYY-MM-DD': { count: N, users: { username: times } }, ... }
   When user logs in:
     - increment today's total
     - increment per-user totalLogins in account
     - if today's per-user count reaches 3, give +2 hints immediately
*/
function trackLoginAndGrant(username){
  const raw = localStorage.getItem(LOGIN_TRACK_KEY);
  let stats = raw ? JSON.parse(raw) : {};
  const today = new Date().toISOString().slice(0,10);
  if(!stats[today]) stats[today] = { total:0, users: {} };
  stats[today].total = (stats[today].total || 0) + 1;
  stats[today].users[username] = (stats[today].users[username] || 0) + 1;
  localStorage.setItem(LOGIN_TRACK_KEY, JSON.stringify(stats));

  // update account totals & grant immediate hint rewards
  const accs = getAccounts();
  const acc = accs[username];
  if(acc){
    acc.rewards.totalLogins = (acc.rewards.totalLogins || 0) + 1;
    // daily-per-user logins count
    const perToday = stats[today].users[username];
    if(perToday >= 3){
      // grant 2 hints for high-frequency login. Only once per day: ensure we don't double grant.
      acc._lastHintGrantDay = acc._lastHintGrantDay || '';
      if(acc._lastHintGrantDay !== today){
        acc.rewards.hints = (acc.rewards.hints || 0) + 2;
        acc._lastHintGrantDay = today;
      }
    }
    saveAccounts(accs);
  }
  console.log('login tracked', stats);
}

/* Utility to inspect login stats (for admin use) */
window._getLoginStats = function(){ return JSON.parse(localStorage.getItem(LOGIN_TRACK_KEY) || '{}'); }

renderPage('login');
</script>
</body>
  </html>
