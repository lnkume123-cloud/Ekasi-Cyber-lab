<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ekasi Cyber Labs â€” Gamified (Profiles + Scoreboard)</title>
  <meta name="description" content="Gamified browser labs: CMD, Linux, Task Manager, Event Viewer, Windows Defender. Profiles, multi-answer support, memos, timer, scoring, and local progress."/>
  <style>
    :root{
      --bg:#0b0f14;--card:#121821;--accent:#6ee7ff;--text:#e5eef7;--muted:#9fb3c8;
      --success:#7ef3b3;--danger:#ff6b6b
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    header{padding:12px 10px;text-align:center;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
    header h1{margin:0;font-size:20px;color:var(--accent)}
    nav{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px}
    nav button{background:none;border:1px solid rgba(255,255,255,.04);color:var(--accent);padding:8px 10px;border-radius:8px;cursor:pointer}
    .wrap{max-width:1100px;margin:18px auto;padding:12px}
    section{display:none}
    section.active{display:block}
    .lab-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px}
    .exercise{border-radius:8px;background:#071013;padding:10px;margin:10px 0;border:1px solid rgba(255,255,255,.03)}
    .output{background:#02060a;padding:10px;border-radius:8px;font-family:monospace;white-space:pre-wrap;color:var(--accent);min-height:44px}
    input[type="text"], input[type="search"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:#07101a;color:var(--text);margin-top:8px}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--text);margin-top:8px;cursor:pointer}
    .small{padding:6px 10px;font-size:13px}
    footer{color:#9fb3c8;text-align:center;font-size:13px;margin-top:20px;padding-bottom:24px}
    .meta{color:var(--muted);font-size:13px;margin-top:8px}
    .score-badge{display:inline-block;padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,var(--accent),#9b83ff);color:#071028;font-weight:700}
    .profile-box{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px}
    .profile-box input{max-width:260px}
    /* Banner */
    .banner{background:linear-gradient(90deg,#0f1720,#07101a);border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:12px}
    .banner .left{flex:1}
    .banner img{max-height:72px;border-radius:8px}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(3,6,10,0.7);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#071219;padding:18px;border-radius:12px;max-width:520px;width:94%;border:1px solid rgba(255,255,255,.04)}
    .modal h3{margin:0 0 8px}
    /* scoreboard table */
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.03);text-align:left}
    @media (max-width:640px){header h1{font-size:18px}; .banner{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <header>
    <h1>Ekasi Cyber Labs â€” Gamified</h1>
    <nav>
      <button onclick="show('home')">Home</button>
      <button onclick="show('cmd')">CMD</button>
      <button onclick="show('linux')">Linux</button>
      <button onclick="show('task')">Task Manager</button>
      <button onclick="show('event')">Event Viewer</button>
      <button onclick="show('defender')">Defender</button>
      <button onclick="show('scoreboard')">Scoreboard</button>
    </nav>
  </header>

  <div class="wrap">
    <!-- HOME -->
    <section id="home" class="active">
      <div class="lab-card">
        <div class="profile-box">
          <input id="profile-name" type="text" placeholder="Enter your name (profile)" />
          <button class="btn small" onclick="setProfile()">Use Profile</button>
          <button class="btn small" onclick="clearProfile()">Clear Profile</button>
          <div style="min-width:12px"></div>
          <div id="profile-show" style="color:var(--muted)"></div>
        </div>

        <div class="banner" style="margin-bottom:12px">
          <div class="left">
            <h3 style="margin:0 0 6px;color:var(--accent)">Get the Ekasi Cybersecurity Ebook</h3>
            <p style="margin:0;color:var(--muted)">Deep-dive labs, memos, and extended solutions â€” download the full guide and support the project.</p>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <a href="https://sotashe.gumroad.com/l/fpohp" target="_blank" rel="noopener noreferrer" class="btn small">Buy Ebook</a>
              <a href="https://60db3kpdiaqaxvafskna3rup72.hop.clickbank.net" target="_blank" rel="noopener noreferrer" class="btn small">Special Tools (ClickBank)</a>
            </div>
          </div>
          <div style="text-align:right">
            <img src="https://via.placeholder.com/120x72.png?text=Ebook+Cover" alt="ebook cover">
          </div>
        </div>

        <h2>Welcome</h2>
        <p class="meta">Choose a lab to practice real-world scenarios. Each lab has 12 exercises. Use memos only when needed â€” they affect your final score. Progress is saved per profile in your browser.</p>
      </div>
    </section>

    <!-- CMD LAB -->
    <section id="cmd">
      <div class="lab-card">
        <h2>CMD Lab â€” Scenarios</h2>
        <div class="meta">Type the correct command & Submit or press Enter. Multiple accepted answers supported (aliases).</div>
        <div id="cmd-exercises-area"></div>
        <div class="meta" id="cmd-status"></div>
        <div style="margin-top:8px"><button class="btn small" onclick="resetLab('cmd')">Reset CMD Lab</button></div>
      </div>
      <div class="banner">
        <div class="left">
          <h3>ðŸ“˜ Level Up Your Skills</h3>
          <p>Get the full Ekasi Cybersecurity Ebook and premium tools for deeper practice.</p>
          <div style="margin-top:8px">
            <a href="https://sotashe.gumroad.com/l/fpohp" target="_blank" class="btn small">Buy Ebook</a>
            <a href="https://60db3kpdiaqaxvafskna3rup72.hop.clickbank.net" target="_blank" class="btn small">Get VPN Tool</a>
          </div>
        </div>
      </div>
    </section>

    <!-- LINUX LAB -->
    <section id="linux">
      <div class="lab-card">
        <h2>Linux Lab â€” Scenarios</h2>
        <div class="meta">Type the exact Linux command required by each scenario.</div>
        <div id="linux-exercises-area"></div>
        <div class="meta" id="linux-status"></div>
        <div style="margin-top:8px"><button class="btn small" onclick="resetLab('linux')">Reset Linux Lab</button></div>
      </div>
      <div class="banner">
        <div class="left">
          <h3>ðŸ“˜ Level Up Your Skills</h3>
          <p>Buy the ebook and pro tools for deeper labs.</p>
          <a href="https://sotashe.gumroad.com/l/fpohp" target="_blank" class="btn small">Buy Ebook</a>
          <a href="https://60db3kpdiaqaxvafskna3rup72.hop.clickbank.net" target="_blank" class="btn small">Get VPN Tool</a>
        </div>
      </div>
    </section>

    <!-- TASK MANAGER LAB -->
    <section id="task">
      <div class="lab-card">
        <h2>Task Manager Lab â€” Scenarios</h2>
        <div class="meta">Simulated Task Manager actions â€” type the action keyword then Submit.</div>
        <div id="task-exercises-area"></div>
        <div class="meta" id="task-status"></div>
        <div style="margin-top:8px"><button class="btn small" onclick="resetLab('task')">Reset Task Manager Lab</button></div>
      </div>
      <div class="banner">
        <div class="left">
          <h3>ðŸ“˜ Level Up Your Skills</h3>
          <p>Buy the full guide for more practice.</p>
          <a href="https://sotashe.gumroad.com/l/fpohp" target="_blank" class="btn small">Buy Ebook</a>
          <a href="https://60db3kpdiaqaxvafskna3rup72.hop.clickbank.net" target="_blank" class="btn small">Get VPN Tool</a>
        </div>
      </div>
    </section>

    <!-- EVENT VIEWER LAB -->
    <section id="event">
      <div class="lab-card">
        <h2>Event Viewer Lab â€” Scenarios</h2>
        <div class="meta">Type the correct action/command to inspect or filter logs.</div>
        <div id="event-exercises-area"></div>
        <div class="meta" id="event-status"></div>
        <div style="margin-top:8px"><button class="btn small" onclick="resetLab('event')">Reset Event Viewer Lab</button></div>
      </div>
      <div class="banner">
        <div class="left">
          <h3>ðŸ“˜ Level Up Your Skills</h3>
          <p>Full ebook + premium tools for serious learners.</p>
          <a href="https://sotashe.gumroad.com/l/fpohp" target="_blank" class="btn small">Buy Ebook</a>
          <a href="https://60db3kpdiaqaxvafskna3rup72.hop.clickbank.net" target="_blank" class="btn small">Get VPN Tool</a>
        </div>
      </div>
    </section>

    <!-- DEFENDER LAB -->
    <section id="defender">
      <div class="lab-card">
        <h2>Windows Defender Lab â€” Scenarios</h2>
        <div class="meta">Simulated Defender actions â€” type commands like <code>scan</code>, <code>update</code>, <code>firewall</code>.</div>
        <div id="defender-exercises-area"></div>
        <div class="meta" id="defender-status"></div>
        <div style="margin-top:8px"><button class="btn small" onclick="resetLab('defender')">Reset Defender Lab</button></div>
      </div>
      <div class="banner">
        <div class="left">
          <h3>ðŸ“˜ Level Up Your Skills</h3>
          <p>Buy the ebook for full memos and solutions.</p>
          <a href="https://sotashe.gumroad.com/l/fpohp" target="_blank" class="btn small">Buy Ebook</a>
          <a href="https://60db3kpdiaqaxvafskna3rup72.hop.clickbank.net" target="_blank" class="btn small">Get VPN Tool</a>
        </div>
      </div>
    </section>

    <!-- SCOREBOARD -->
    <section id="scoreboard">
      <div class="lab-card">
        <h2>Scoreboard â€” Profile Progress</h2>
        <div class="meta">Shows per-lab completion and latest score for the active profile.</div>
        <div id="scoreboard-area"></div>
      </div>
    </section>

    <footer>
      Â© <span id="yr"></span> Ekasi Production â€” Built by Luthando. Educational use only.
    </footer>
  </div>

  <!-- Modal root -->
  <div id="modal-root" style="display:none"></div>

<script>
// ---- auth check ----
const LOGGED_IN_KEY = 'ekasi_logged_in_user_v1';
const user = localStorage.getItem(LOGGED_IN_KEY);
if(!user){
  window.location.href = "auth.html";
}
// optional logout button anywhere:
function logout(){
  localStorage.removeItem(LOGGED_IN_KEY);
  localStorage.removeItem(LOGGED_IN_KEY+"_auto");
  window.location.href="auth.html";
  }
  /* ---------------- Helpers ---------------- */
document.getElementById('yr').textContent = new Date().getFullYear();
function show(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
  if(id==='scoreboard') renderScoreboard();
}
function sanitize(s){ return s?String(s).replace(/[<>&"'`]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])):'' }

/* ------------- Profile handling ------------- */
let currentProfile = null;
function setProfile(){
  const name = (document.getElementById('profile-name').value || '').trim();
  if(!name){ alert('Type a name for the profile'); return; }
  currentProfile = name.replace(/\s+/g,'_').toLowerCase();
  document.getElementById('profile-show').textContent = `Profile: ${name}`;
  // initialize labs if not present
  ['cmd','linux','task','event','defender'].forEach(initLab);
  renderScoreboard();
}
function clearProfile(){
  if(confirm('Clear active profile selection?')) {
    currentProfile = null;
    document.getElementById('profile-show').textContent = '';
    document.getElementById('profile-name').value = '';
  }
}
function profileChecked(){
  if(!currentProfile){
    alert('Please set a profile name first (top of Home).');
    throw new Error('No profile set');
  }
}
function makeLabKey(labId){ return `ekasi_lab_state_${currentProfile || 'default'}_${labId}`; }
function loadState(labId){
  try{
    profileChecked();
    const raw = localStorage.getItem(makeLabKey(labId));
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveState(labId, state){
  try{ profileChecked(); localStorage.setItem(makeLabKey(labId), JSON.stringify(state)); }catch(e){}
}
function resetLab(labId){
  // This wrapper ensures profile is present and will reinitialize UI after clearing storage
  profileChecked();
  if(!confirm('Reset all progress for this lab?')) return;
  localStorage.removeItem(makeLabKey(labId));
  // re-create a fresh state and re-render the lab
  const areaMap = {
    cmd:{data:cmdExercises},
    linux:{data:linuxExercises},
    task:{data:taskExercisesData},
    event:{data:eventExercisesData},
    defender:{data:defenderExercisesData}
  };
  const template = areaMap[labId];
  if(template){
    const fresh = {
      startTime: null,
      endTime: null,
      exercises: template.data.map(()=>({attempts:0,memoClicked:false,memoClickedBeforeAttempt:false,completedAt:null}))
    };
    // save a fresh state (so UI sees it)
    try{ localStorage.setItem(makeLabKey(labId), JSON.stringify(fresh)); }catch(e){}
  } else {
    localStorage.removeItem(makeLabKey(labId));
  }
  initLab(labId);
  renderScoreboard();
}

/* ---------- scoring same engine as before, now profile-aware ---------- */
function computeScore(state){
  if(!state) return {score:0,totalSeconds:0,completed:0,total:0,memoBefore:false,anyMemoUsed:false};
  const exercises = state.exercises || [];
  const total = exercises.length;
  const completed = exercises.filter(e=>e.completedAt).length;
  const now = state.endTime || Date.now();
  const start = state.startTime || now;
  const totalSeconds = Math.max(1, Math.round((now - start)/1000));
  let memoBefore = exercises.some(e=>e.memoClickedBeforeAttempt);
  let anyMemoUsed = exercises.some(e=>e.memoClicked);
  let base;
  if(memoBefore) base = 60;
  else if(anyMemoUsed) base = 65;
  else base = 70;
  let bonus = 0;
  if(memoBefore) bonus = 0;
  else if(anyMemoUsed){
    if(totalSeconds < 300) bonus = 10;
    else if(totalSeconds < 600) bonus = 5;
  } else {
    if(totalSeconds < 180) bonus = 30;
    else if(totalSeconds < 300) bonus = 20;
    else if(totalSeconds < 600) bonus = 10;
  }
  let score = Math.min(100, base + bonus);
  if(completed < total){
    const frac = completed / total;
    score = Math.round((base + bonus) * frac);
  } else {
    score = Math.round(score);
  }
  return { score, totalSeconds, completed, total, memoBefore, anyMemoUsed };
}

/* ---------- Modal UI ---------- */
function showModal(html){ const root = document.getElementById('modal-root'); root.innerHTML = `<div class="modal-backdrop"><div class="modal">${html}</div></div>`; root.style.display='block'; }
function closeModal(){ document.getElementById('modal-root').style.display='none'; document.getElementById('modal-root').innerHTML=''; }

/* ---------- CSV export ---------- */
function downloadReport(labId){
  profileChecked();
  const state = loadState(labId);
  if(!state){ alert('No data to export'); return; }
  const { score, totalSeconds, completed, total } = computeScore(state);
  let csv = `Lab,${labId}\nProfile,${currentProfile}\nScore,${score}\nTimeSeconds,${totalSeconds}\nCompleted,${completed}/${total}\n\nExercise,Attempted,MemoClicked,MemoBeforeAttempt,CompletedAt\n`;
  state.exercises.forEach((ex,i)=>{
    csv += `${i+1},"${ex.attempts || 0}",${ex.memoClicked?1:0},${ex.memoClickedBeforeAttempt?1:0},${ex.completedAt?new Date(ex.completedAt).toISOString():""}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `ekasi_${currentProfile}_${labId}_report.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Accept multiple answers helper ---------- */
function normalizeAnswer(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,' '); }
function isAnswerMatch(user, answer){
  // answer may be string or array
  const u = normalizeAnswer(user);
  if(!u) return false;
  if(Array.isArray(answer)){
    return answer.map(normalizeAnswer).some(a=>a === u);
  } else {
    return normalizeAnswer(answer) === u;
  }
}

/* ========== LAB Data (with multi-answer support where useful) ========== */
/* Each answer may be a string or an array of strings (aliases) */

/* CMD */
const cmdExercises = [
  {scenario:"1) The helpdesk reports no internet access on one PC. Test basic connectivity to Google.", answer:["ping google.com","ping www.google.com"], memo:"Use ping to check network reachability: ping google.com"},
  {scenario:"2) Check the machine's IPv4 address and interface settings.", answer:["ipconfig","ipconfig /all"], memo:"Windows command to show IP config: ipconfig"},
  {scenario:"3) The user can't reach a website; show active TCP connections to locate suspicious external IPs.", answer:"netstat", memo:"Use netstat to view active connections"},
  {scenario:"4) List all files in the current directory to locate a suspicious file.", answer:["dir","dir /b"], memo:"dir lists files in Windows CMD"},
  {scenario:"5) Move into the Windows system folder to inspect system files.", answer:["cd c:\\windows","cd C:\\Windows"], memo:"Change directory to C:\\Windows using cd C:\\Windows"},
  {scenario:"6) The screen is cluttered; clear the command window to start fresh.", answer:"cls", memo:"Use cls to clear Command Prompt screen"},
  {scenario:"7) Create a folder to collect logs named 'LabLogs'.", answer:["mkdir lablogs","mkdir LabLogs"], memo:"Use mkdir <foldername> to create a directory"},
  {scenario:"8) Remove a temporary test file named 'temp.txt'.", answer:["del temp.txt","del \"temp.txt\""], memo:"Use del <filename> to delete files"},
  {scenario:"9) Show current system date.", answer:["date /t","date"], memo:"Use date /t to display the date"},
  {scenario:"10) Show current system time.", answer:["time /t","time"], memo:"Use time /t to display the current time"},
  {scenario:"11) List running tasks to identify high-CPU processes.", answer:["tasklist"], memo:"tasklist shows running processes in Windows"},
  {scenario:"12) Simulate scheduling a shutdown in 60 seconds.", answer:["shutdown /s /t 60"], memo:"Use shutdown /s /t <seconds> to schedule a shutdown"}
];

/* LINUX */
const linuxExercises = [
  {scenario:"1) A server cannot access external sites. Test connectivity to 8.8.8.8.", answer:["ping 8.8.8.8","ping -c 4 8.8.8.8"], memo:"Use ping 8.8.8.8 to test connectivity"},
  {scenario:"2) List files in the current directory to find config files.", answer:["ls","ls -la"], memo:"ls lists files"},
  {scenario:"3) Show the current working directory.", answer:"pwd", memo:"pwd prints current directory"},
  {scenario:"4) Create a directory named 'lab' for practice.", answer:["mkdir lab","mkdir ./lab"], memo:"mkdir <name> creates a directory"},
  {scenario:"5) Remove a test file named 'old.log'.", answer:["rm old.log","rm ./old.log"], memo:"rm <filename> removes a file"},
  {scenario:"6) Display the contents of /etc/hosts.", answer:"cat /etc/hosts", memo:"Use cat /etc/hosts to view the hosts file"},
  {scenario:"7) Create an empty file called todo.txt.", answer:"touch todo.txt", memo:"touch <filename> creates an empty file"},
  {scenario:"8) Show the current username.", answer:["whoami","id -un"], memo:"whoami prints the current user"},
  {scenario:"9) Display system information.", answer:"uname -a", memo:"uname -a shows kernel and system info"},
  {scenario:"10) Show active network interfaces.", answer:["ifconfig","ip addr"], memo:"ifconfig shows network interface info (or ip addr on some systems)"},
  {scenario:"11) List running processes.", answer:["ps","ps aux"], memo:"ps shows running processes"},
  {scenario:"12) Simulate shutdown immediately.", answer:["shutdown -h now","sudo shutdown -h now"], memo:"shutdown -h now halts the system (simulated)"}
];

/* TASK MANAGER */
const taskExercisesData = [
  {scenario:"1) An app is not responding. Show the list of processes.", answer:["list","process list"], memo:"Use 'list' to view running processes (simulated)"},
  {scenario:"2) Check current CPU usage to find spikes.", answer:["cpu"], memo:"Use 'cpu' to show CPU usage"},
  {scenario:"3) Check memory usage.", answer:["memory"], memo:"Use 'memory' to view memory usage"},
  {scenario:"4) Kill a misbehaving browser (chrome.exe).", answer:["kill chrome.exe","kill chrome"], memo:"Use 'kill chrome.exe' to terminate the process (simulated)"},
  {scenario:"5) Show disk usage stats.", answer:["disk"], memo:"Use 'disk' to show disk usage"},
  {scenario:"6) Show current network activity.", answer:["network"], memo:"Use 'network' to display network usage"},
  {scenario:"7) List running services.", answer:["services"], memo:"Use 'services' to list services"},
  {scenario:"8) Show logged-in users.", answer:["users"], memo:"Use 'users' to list logged-in accounts"},
  {scenario:"9) Show detailed process info.", answer:["details"], memo:"Use 'details' to view process details"},
  {scenario:"10) Show startup programs.", answer:["startup"], memo:"Use 'startup' to view startup apps"},
  {scenario:"11) Show performance charts.", answer:["performance"], memo:"Use 'performance' to see performance metrics"},
  {scenario:"12) Show application history for last 24h.", answer:["history"], memo:"Use 'history' to show app history"}
];

/* EVENT VIEWER */
const eventExercisesData = [
  {scenario:"1) Open Event Viewer to inspect logs.", answer:["open"], memo:"Use 'open' to open Event Viewer (simulated)"},
  {scenario:"2) View System logs.", answer:["view system","view system logs"], memo:"Use 'view system' to show system logs"},
  {scenario:"3) View Application logs.", answer:["view application"], memo:"Use 'view application' to show application logs"},
  {scenario:"4) View Security logs.", answer:["view security"], memo:"Use 'view security' to see security-related events"},
  {scenario:"5) Find recent error events.", answer:["filter error","filter errors"], memo:"Use 'filter error' to filter for errors"},
  {scenario:"6) Find recent warnings.", answer:["filter warning","filter warnings"], memo:"Use 'filter warning' to show warnings"},
  {scenario:"7) Show informational logs.", answer:["filter info","filter information"], memo:"Use 'filter info' to show info logs"},
  {scenario:"8) Export logs for analysis.", answer:["export logs","export"], memo:"Use 'export logs' to export selected logs"},
  {scenario:"9) Clear logs (simulated).", answer:["clear logs","clear"], memo:"Use 'clear logs' to clear viewer (simulated)"},
  {scenario:"10) Search logs for a username.", answer:["find user","search user"], memo:"Use 'find user' to search logs for events by user"},
  {scenario:"11) Generate reliability report.", answer:["reliability report","generate reliability report"], memo:"Use 'reliability report' to create report"},
  {scenario:"12) Filter critical events only.", answer:["filter critical"], memo:"Use 'filter critical' to show only critical events"}
];

/* DEFENDER */
const defenderExercisesData = [
  {scenario:"1) Run a quick malware scan.", answer:["scan","quick scan"], memo:"Use 'scan' to run a quick scan"},
  {scenario:"2) Run a full system scan.", answer:["fullscan","full scan"], memo:"Use 'fullscan' for full system scan"},
  {scenario:"3) Check for security intelligence updates.", answer:["update","check update"], memo:"Use 'update' to check for updates"},
  {scenario:"4) Enable real-time protection.", answer:["realtime","enable realtime"], memo:"Use 'realtime' to enable real-time protection"},
  {scenario:"5) Disable real-time protection (simulated).", answer:["disable"], memo:"Use 'disable' to turn off protection (simulated)"},
  {scenario:"6) Enable firewall.", answer:["firewall","enable firewall"], memo:"Use 'firewall' to enable firewall"},
  {scenario:"7) Check firewall status.", answer:["checkfirewall","firewall status"], memo:"Use 'checkfirewall' to view firewall status"},
  {scenario:"8) View threat history.", answer:["history","view history"], memo:"Use 'history' to view past threats"},
  {scenario:"9) Remove a detected threat.", answer:["remove","remove threat"], memo:"Use 'remove' to delete a detected threat"},
  {scenario:"10) Schedule daily scan at 2 AM.", answer:["schedule","schedule scan"], memo:"Use 'schedule' to plan daily scans"},
  {scenario:"11) Open Defender settings.", answer:["settings","open settings"], memo:"Use 'settings' to open configuration"},
  {scenario:"12) Generate a security report.", answer:["report","generate report"], memo:"Use 'report' to create a security report"}
];

/* ========== Build Lab UI & Logic (profile-aware) ========== */
function initLab(labId){
  const areaMap = {
    cmd:{data:cmdExercises, areaId:'cmd-exercises-area', statusId:'cmd-status'},
    linux:{data:linuxExercises, areaId:'linux-exercises-area', statusId:'linux-status'},
    task:{data:taskExercisesData, areaId:'task-exercises-area', statusId:'task-status'},
    event:{data:eventExercisesData, areaId:'event-exercises-area', statusId:'event-status'},
    defender:{data:defenderExercisesData, areaId:'defender-exercises-area', statusId:'defender-status'}
  };
  const entry = areaMap[labId];
  const area = document.getElementById(entry.areaId);
  area.innerHTML = '';

  if(!currentProfile){
    area.innerHTML = `<div class="meta">Please enter a profile name on Home and click "Use Profile" to start this lab.</div>`;
    document.getElementById(entry.statusId).textContent = 'No profile selected';
    return;
  }

  // load or create state
  let state = loadState(labId);
  if(!state){
    state = {
      startTime: null,
      endTime: null,
      exercises: entry.data.map(()=>({attempts:0,memoClicked:false,memoClickedBeforeAttempt:false,completedAt:null}))
    };
    saveState(labId, state);
  }

  // render each exercise
  entry.data.forEach((ex, idx)=>{
    const exState = state.exercises[idx];
    const exDiv = document.createElement('div');
    exDiv.className = 'exercise';
    exDiv.id = `${labId}-ex-${idx}`;
    exDiv.innerHTML = `
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:6px">${sanitize(ex.scenario)}</div>
          <div id="${labId}-out-${idx}" class="output">${exState.completedAt ? 'âœ… Completed' : (labId==='cmd' ? 'C:\\> ' : labId==='linux' ? 'student@ekasi:~$ ' : '')}</div>
          <input id="${labId}-in-${idx}" type="text" placeholder="Type command here" ${exState.completedAt? 'disabled':''}>
          <div style="margin-top:8px">
            <button class="btn small" id="${labId}-submit-${idx}">Submit</button>
            <button class="btn small" id="${labId}-memo-${idx}">Show Memo</button>
          </div>
        </div>
        <div style="min-width:120px;text-align:right">
          <div style="font-size:13px;color:var(--muted)">Attempts: <span id="${labId}-att-${idx}">${exState.attempts||0}</span></div>
          <div style="font-size:13px;color:var(--muted);margin-top:6px">Memo used: <span id="${labId}-mc-${idx}">${exState.memoClicked? 'Yes':'No'}</span></div>
        </div>
      </div>
    `;
    area.appendChild(exDiv);

    // wires
    const inputEl = document.getElementById(`${labId}-in-${idx}`);
    const submitBtn = document.getElementById(`${labId}-submit-${idx}`);
    const memoBtn = document.getElementById(`${labId}-memo-${idx}`);
    const outEl = document.getElementById(`${labId}-out-${idx}`);
    const attEl = document.getElementById(`${labId}-att-${idx}`);
    const mcEl = document.getElementById(`${labId}-mc-${idx}`);

    memoBtn.addEventListener('click', ()=>{
      if(!state.startTime) state.startTime = Date.now();
      if(!exState.attempts) exState.memoClickedBeforeAttempt = true;
      exState.memoClicked = true;
      mcEl.textContent = 'Yes';
      saveState(labId, state);
      alert('ðŸ’¡ Memo: ' + ex.memo);
      updateStatus(labId, state);
    });

    function markCompleted(){
      exState.completedAt = Date.now();
      outEl.textContent = 'âœ… Completed';
      inputEl.disabled = true;
      submitBtn.disabled = true;
      memoBtn.disabled = true;
      attEl.textContent = exState.attempts || 0;
      saveState(labId, state);
      updateStatus(labId, state);
      if(state.exercises.every(e=>e.completedAt)){
        state.endTime = Date.now();
        saveState(labId, state);
        setTimeout(()=> showLabComplete(labId, state), 350);
      }
    }

    function submitHandler(){
      if(!state.startTime) state.startTime = Date.now();
      const raw = inputEl.value || '';
      const user = sanitize(raw.trim().toLowerCase());
      if(!user){ alert('Type a command first'); return; }
      exState.attempts = (exState.attempts||0) + 1;
      attEl.textContent = exState.attempts;
      saveState(labId, state);
      if(isAnswerMatch(user, ex.answer)){
        outEl.textContent += `\n> ${user}\nâœ” Correct`;
        markCompleted();
      } else {
        outEl.textContent += `\n> ${user}\nâœ– Incorrect â€” try again or Show Memo.`;
      }
      inputEl.value = '';
    }

    submitBtn.addEventListener('click', submitHandler);
    inputEl.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') submitHandler(); });
  }); // end each

  updateStatus(labId, state);
}

/* update status area */
function updateStatus(labId, state){
  const statusIdMap = {cmd:'cmd-status', linux:'linux-status', task:'task-status', event:'event-status', defender:'defender-status'};
  const statusEl = document.getElementById(statusIdMap[labId]);
  if(!statusEl) return;
  const st = state || loadState(labId);
  if(!st) { statusEl.textContent = 'Not started'; return; }
  const completed = st.exercises.filter(e=>e.completedAt).length;
  const anyMemoBefore = st.exercises.some(e=>e.memoClickedBeforeAttempt);
  const anyMemo = st.exercises.some(e=>e.memoClicked);
  const started = !!st.startTime;
  const elapsed = started ? Math.round(( (st.endTime||Date.now()) - st.startTime)/1000) : 0;
  statusEl.innerHTML = `Profile: ${currentProfile} &nbsp;|&nbsp; Progress: ${completed}/${st.exercises.length} &nbsp;|&nbsp; Time: ${elapsed}s &nbsp;|&nbsp; Memos used: ${anyMemo? 'Yes':'No'} ${anyMemoBefore? '(some before attempt)':''}`;
}

/* show lab complete modal */
function showLabComplete(labId, state){
  const res = computeScore(state);
  const html = `
    <h3>ðŸŽ‰ Lab Complete â€” ${labId.toUpperCase()}</h3>
    <p>You completed <strong>${res.completed}/${res.total}</strong> exercises.</p>
    <p>Time: <strong>${res.totalSeconds}s</strong></p>
    <p>Score: <span class="score-badge">${res.score}%</span></p>
    <p style="color:var(--muted)">${res.memoBefore ? 'You used memos before attempting some exercises (penalty applied).' : res.anyMemoUsed ? 'You used memos during the lab.' : 'No memos used â€” well done!'}</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn small" onclick="closeModal();">Close</button>
      <button class="btn small" onclick="downloadReport('${labId}');">Download Report</button>
      <button class="btn small" onclick="resetLab('${labId}'); closeModal();">Reset Lab</button>
    </div>`;
  showModal(html);
  renderScoreboard();
}

/* Scoreboard render */
function renderScoreboard(){
  if(!currentProfile){ document.getElementById('scoreboard-area').innerHTML = '<div class="meta">Set a profile on Home to view scoreboard.</div>'; return; }
  const labs = ['cmd','linux','task','event','defender'];
  let html = `<table><thead><tr><th>Lab</th><th>Completed</th><th>Time (s)</th><th>Score</th><th>Actions</th></tr></thead><tbody>`;
  labs.forEach(l=>{
    const st = loadState(l);
    if(!st){ html += `<tr><td>${l.toUpperCase()}</td><td>0/12</td><td>-</td><td>-</td><td><button class="btn small" onclick="initLab('${l}')">Start</button></td></tr>`; }
    else{
      const res = computeScore(st);
      html += `<tr>
        <td>${l.toUpperCase()}</td>
        <td>${res.completed}/${res.total}</td>
        <td>${res.totalSeconds}</td>
        <td>${res.score}%</td>
        <td>
          <button class="btn small" onclick="showLabReport('${l}')">View</button>
          <button class="btn small" onclick="resetLab('${l}')">Reset</button>
        </td>
      </tr>`;
    }
  });
  html += '</tbody></table>';
  document.getElementById('scoreboard-area').innerHTML = html;
}

/* quick view modal for lab report */
function showLabReport(labId){
  profileChecked();
  const st = loadState(labId);
  if(!st){ alert('No data'); return; }
  const res = computeScore(st);
  let rows = '';
  st.exercises.forEach((ex,i)=>{ rows += `<tr><td>${i+1}</td><td>${ex.attempts||0}</td><td>${ex.memoClicked? 'Yes':'No'}</td><td>${ex.memoClickedBeforeAttempt? 'Yes':'No'}</td><td>${ex.completedAt? new Date(ex.completedAt).toLocaleString() : '-'}</td></tr>`; });
  const html = `
    <h3>Report â€” ${labId.toUpperCase()}</h3>
    <p>Profile: ${currentProfile} â€” Score: <strong>${res.score}%</strong> â€” Time: ${res.totalSeconds}s</p>
    <table style="width:100%"><thead><tr><th>#</th><th>Attempts</th><th>MemoUsed</th><th>MemoBefore</th><th>CompletedAt</th></tr></thead><tbody>${rows}</tbody></table>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn small" onclick="closeModal()">Close</button>
      <button class="btn small" onclick="downloadReport('${labId}')">Download CSV</button>
    </div>`;
  showModal(html);
}

/* initialize all labs when profile is set or page loads */
['cmd','linux','task','event','defender'].forEach(id=>{
  document.addEventListener('DOMContentLoaded', ()=>{ /* placeholder */ });
});

/* expose functions globally */
window.resetLab = function(l){ if(!currentProfile){ alert('Set profile first'); return; } resetLab(l); }
window.downloadReport = function(l){ if(!currentProfile){ alert('Set profile first'); return; } downloadReport(l); }

/* small helper: ensure profile set when page interaction */
function profileChecked(){
  if(!currentProfile){
    alert('Please set a profile on the Home tab and click "Use Profile" first.');
    throw new Error('No profile set');
  }
}

/* When profile is set, initialize labs */
(function watchProfileInput(){
  const input = document.getElementById('profile-name');
  input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ setProfile(); }});
})();

/* After profile set we must init labs & render scoreboard */
const _oldSetProfile = setProfile;
setProfile = function(){
  const name = (document.getElementById('profile-name').value || '').trim();
  if(!name){ alert('Type a name for the profile'); return; }
  currentProfile = name.replace(/\s+/g,'_').toLowerCase();
  document.getElementById('profile-show').textContent = `Profile: ${name}`;
  ['cmd','linux','task','event','defender'].forEach(initLab);
  renderScoreboard();
};

/* On first load, show placeholder profile message */
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('profile-show').textContent = ''; });

</script>
</body>
            </html>
